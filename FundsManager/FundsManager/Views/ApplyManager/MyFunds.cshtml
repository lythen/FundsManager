@model FundsManager.ViewModels.BillsSearchModel
@{
    ViewBag.Title = FundsManager.Controllers.SiteInfo.getSiteName() + "我的经费列表";
    List <FundsManager.ViewModels.ApplyListModel> Bills = (List<FundsManager.ViewModels.ApplyListModel>)ViewData["Bills"];

}

<hr />
<style>
    .table .table tbody tr td, .table .table tbody tr th, .table .table tfoot tr td, .table .table tfoot tr th, .table .table thead tr td, .table .table thead tr th{border-top:none;}
    .displayN{display:none;}
</style>

@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()
    <div class="form-horizontal">
        <div class="form-group">
            <div class="col-md-10">
                @*经费：@Html.DropDownListFor(model => model.fund, Model.fund, ViewBag.Funds as List<SelectListItem>, "---全部---", new Dictionary<string, object> { { "class", "select form-control" } })
                @Html.ValidationMessageFor(model => model.fund, "", new { @class = "text-danger" })
                统计选项：@Html.DropDownListFor(model => model.statorDetail, Model.statorDetail, ViewBag.StatorDetail as List<SelectListItem>, "", new Dictionary<string, object> { { "class", "select form-control" } })
                @Html.ValidationMessageFor(model => model.statorDetail, "", new { @class = "text-danger" })*@
                <input type="submit" value="刷新" class="btn btn-info" />
            </div>
        </div>
    </div>
<div class="col-md-10" id="msg">
    @ViewBag.msg
</div>
<table class="table">
    <tr>
        <th>
            编号
        </th>
        <th>使用经费</th>
        <th>报销金额</th>
        <th>
            填表时间
        </th>
        <th>报销项目</th>
        <th>
            附件数
        </th>
        <th>
            状态
        </th>
        <th class="th-no">操作</th>
    </tr>
    @if (Bills != null && Bills.Count() > 0)
    {
        var canDel = true;
        foreach (var item in Bills)
        {

            if (item.state == 1) { canDel = false; }
            <tr id="tr_@item.reimbursementCode">
                <td>
                    @Html.DisplayFor(modelItem => item.reimbursementCode)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.fundsName) (@Html.DisplayFor(modelItem => item.fundsCode))
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.amount) 元
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.time)
                </td>
                <td>
                    <table class="table">
                        @if (item.contents != null && item.contents.Count() > 0)
                        {
                            foreach (var citem in item.contents)
                            {
                                <tr>
                                    <td class="td-no">
                                        @citem.contentTitle
                                    </td>
                                    <td class="td-co">
                                        @Html.DisplayFor(@Citem => @citem.amount) 元
                                    </td>
                                </tr>
                            }
                        }
                    </table>
                </td>
               <td>
                   @item.attachmentsCount
               </td>
                <td>
                    @item.strState
                </td>
                <td>
                    @Html.ActionLink("详细", "Details", new { id = item.reimbursementCode }, new { @class = "btn btn-info" })
                  @Html.ActionLink("修改", "Edit", new { id = item.reimbursementCode }, new { @class = "btn btn-success" })
                    @if (@canDel)
                    {
                        <a href="javascript:void(0);" class="btn btn-default" onclick="DelCApply('@item.reimbursementCode')">撤销</a>
                    }
                </td>
            </tr>
        }
    }
    else
    {
        <tr><td colspan="8" align="center">当前没有申请的经费</td></tr>
    }
</table>
}
<script src="~/scripts/jquery-1.10.2.min.js"></script>
<script>
    function DelCApply(number) {
        var obj = new Object();
        obj.number = number;
        $.post("@Url.RouteUrl(new {controller= "ApplyManager", action= "Delete" })", obj, function (data) {
            if (data.state == '1') {
                $('#msg').removeClass();
                $('#msg').addClass('alert alert alert-success');
                $('#msg').text("申请单撤销成功。");
                $('#tr_' + number).remove();
                removeAlert();
                
            } else {
                if (data.msg_code == 'nologin') location.href = '@Url.RouteUrl(new { action = "LogOut", controller = "Login"})';
                $('#msg').removeClass();
                $('#msg').addClass('alert alert alert-danger');
                $('#msg').text(data.msg_text);
                removeAlert();
            }
        });
    }
    function removeAlert() {
        setTimeout(function () {
            $('#msg').removeClass();
            $('#msg').addClass('displayN');
        }, 3000);
    }
    $(function () {
        var w = $('.th-no').width();
        $('.td-no').width(w);
        var w = $('.th-co').width();
        $('.td-co').width(w);
        var w = $('.th-am').width();
        $('.td-am').width(w);
        var w = $('.th-st').width();
        $('.td-st').width(w);
    });
</script>